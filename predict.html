<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Shark Tracking - Model Prediction</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦ˆ</text></svg>">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Custom CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-title {
            flex: 1;
        }

        .header-title h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header-title p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            gap: 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 4px;
        }

        .nav-tab {
            padding: 10px 20px;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .nav-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-tab.active {
            color: white;
            background: #3498db;
        }

        .container {
            display: flex;
            height: calc(100vh - 120px);
            position: relative;
        }

        .menu-toggle {
            position: absolute;
            top: 10px;
            left: 365px; /* 350px sidebar width + 15px spacing */
            z-index: 1001;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: left 0.3s ease, background-color 0.2s ease;
        }

        .container.sidebar-hidden .menu-toggle {
            left: 15px; /* 15px from left when sidebar is hidden */
        }

        .menu-toggle:hover {
            background: rgba(255, 255, 255, 1);
        }

        .menu-toggle svg {
            display: block;
        }

        .sidebar {
            width: 350px;
            background-color: white;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .controls {
            margin-bottom: 2rem;
        }

        .control-group {
            margin-bottom: 1rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #34495e;
        }

        .control-group button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .control-group button:hover {
            background-color: #2980b9;
        }

        .control-group button.active {
            background-color: #27ae60;
        }

        .control-group button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .control-group button:disabled:hover {
            background-color: #95a5a6;
        }

        /* Loading indicator styles */
        .button-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .button-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            right: -25px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .shark-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 0.5rem;
            background-color: #fafafa;
        }

        .shark-item {
            padding: 1rem;
            border: 1px solid #ecf0f1;
            border-radius: 4px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            position: relative;
        }

        .shark-item:hover {
            background-color: #ecf0f1;
        }

        .shark-item.selected {
            background-color: #e8f4f8;
            border-color: #3498db;
        }

        .shark-visibility-toggle {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.4rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .shark-visibility-toggle:hover {
            background: rgba(255, 255, 255, 1);
            border-color: #3498db;
            transform: scale(1.05);
        }

        .shark-visibility-toggle svg {
            width: 20px;
            height: 20px;
            transition: fill 0.2s ease;
        }

        .shark-visibility-toggle:hover svg {
            fill: #3498db !important;
        }

        .shark-visibility-toggle.hidden {
            display: none;
        }

        .shark-emoji-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        /* Prediction Color Scale Styles */
        .prediction-scale {
            position: absolute;
            top: 70px;
            left: 20px;
            width: 30px;
            height: 200px;
            z-index: 1000;
            background: white;
            border: 2px solid #333;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .prediction-scale-gradient {
            flex: 1;
            width: 100%;
            border-radius: 2px 2px 0 0;
            background: linear-gradient(to top, #00ff00 0%, #ffff00 50%, #ff0000 100%);
        }

        .prediction-scale-labels {
            position: absolute;
            left: 35px;
            top: 0;
            height: 100%;
            width: 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 11px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 6px;
            border-radius: 0 2px 2px 0;
            text-align: left;
        }

        .prediction-scale-title {
            position: absolute;
            bottom: -30px;
            left: 0;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 3px 6px;
            border-radius: 2px;
            white-space: nowrap;
        }

        /* Map Legend Styles */
        .map-legend {
            position: absolute;
            top: 310px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #333;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            padding: 8px 12px;
            font-size: 13px;
            font-family: Arial, sans-serif;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #333;
        }

        .legend-item .emoji {
            font-size: 18px;
        }

        .shark-id {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .shark-details {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .shark-details div {
            margin-bottom: 0.2rem;
        }

        #map {
            flex: 1;
            position: relative;
            transition: margin-left 0.3s ease;
        }

        .container.sidebar-hidden #map {
            margin-left: -350px;
        }

        .legend {
            position: absolute;
            top: 60px; /* Below the menu toggle button */
            left: 15px; /* Same as menu toggle when sidebar is open */
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 0.75rem;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 120px;
            backdrop-filter: blur(5px);
        }

        .legend:hover {
            background-color: rgba(255, 255, 255, 0.95);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .container.sidebar-hidden .legend {
            left: 15px; /* 15px from left when sidebar is hidden */
        }

        .legend.collapsed {
            padding: 0.5rem 0.75rem;
        }

        .legend-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .legend.collapsed .legend-header {
            margin-bottom: 0;
        }

        .legend-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .legend-toggle {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-left: 0.5rem;
        }

        .legend-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .legend.collapsed .legend-content {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.3rem;
            font-size: 0.85rem;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            margin-right: 0.5rem;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .legend-emoji {
            font-size: 16px;
            margin-right: 0.5rem;
            flex-shrink: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .legend-text {
            color: #2c3e50;
            line-height: 1.2;
        }

        .legend-shark-list {
            overflow-y: auto;
        }

        .legend-shark-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.2rem;
            font-size: 0.8rem;
        }

        .legend-shark-item:last-child {
            margin-bottom: 0;
        } */

        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .stats {
            background-color: #ecf0f1;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .stats h4 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
        }

        .stats-label {
            color: #7f8c8d;
        }

        .stats-value {
            font-weight: bold;
            color: #2c3e50;
        }

        /* Bottom time control panel styles */
        .bottom-time-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            display: block;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

		/* Removed */
        /* .time-control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .time-control-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9rem;
        } */

        .time-control-info {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .time-control-main {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .play-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #3498db;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .play-button:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        .play-button.playing {
            background: #e74c3c;
        }

        .play-button.playing:hover {
            background: #c0392b;
        }

        .bottom-time-slider-container {
            flex: 1;
            margin: 0 8px;
        }

        .bottom-time-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ecf0f1;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bottom-time-slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .bottom-time-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        .bottom-time-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .time-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #7f8c8d;
            margin-top: 8px;
        }

        .time-labels.white-text #bottom-start-time, .time-labels.white-text #bottom-end-time {
            background-color: #555;
            border-radius: 2px;
            color: white;
            padding: 0 2px;
        }

        .current-time-label {
            color: #3498db;
            font-weight: bold;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: #7f8c8d;
            flex-shrink: 0;
        }

        .speed-button {
            background: none;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            color: #7f8c8d;
            transition: all 0.2s ease;
        }

        .speed-button:hover {
            background: #ecf0f1;
            border-color: #95a5a6;
        }

        .speed-button.active {
            background: #3498db;
            border-color: #3498db;
            color: white;
        }

        .follow-button {
            background: none;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.75rem;
            color: #7f8c8d;
            transition: all 0.2s ease;
            flex-shrink: 0;
            white-space: nowrap;
            margin-left: 12px;
        }

        .follow-button:hover {
            background: #ecf0f1;
            border-color: #95a5a6;
        }

        .follow-button.active {
            background: #27ae60;
            border-color: #27ae60;
            color: white;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: #3498db;
            color: white;
            padding: 48px 72px;
            border-radius: 24px;
            box-shadow: 0 12px 48px rgba(52, 152, 219, 0.3);
            font-family: Arial, sans-serif;
            font-size: 42px;
            z-index: 10000;
            cursor: pointer;
            animation: slideDown 0.3s ease-out;
            max-width: 1200px;
            text-align: center;
            border-left: 12px solid #2980b9;
        }

        .notification:hover {
            background: #2980b9;
            transform: translateX(-50%) scale(1.02);
            transition: all 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .notification.fadeOut {
            animation: fadeOut 0.3s ease-out forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }

        @keyframes shark-pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
        }

        /* Color Scale Styles */
        .color-scale {
            position: absolute;
            top: 250px;
            left: 20px;
            width: 30px;
            height: 200px;
            z-index: 1000;
            background: white;
            border: 2px solid #333;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
        }

        .color-scale.visible {
            display: flex;
        }

        .color-scale-gradient {
            flex: 1;
            width: 100%;
            border-radius: 2px 2px 0 0;
        }

        .color-scale-labels {
            position: absolute;
            left: 35px;
            top: 0;
            height: 100%;
            width: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 10px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 0 2px 2px 0;
        }

        .color-scale-title {
            position: absolute;
            bottom: -25px;
            font-size: 11px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 2px;
            white-space: nowrap;
        }

        #chl-scale .color-scale-gradient {
            background: linear-gradient(to top, #000080 0%, #0066cc 25%, #00ccff 50%, #66ff66 75%, #ffff00 100%);
        }

        #sst-scale .color-scale-gradient {
            background: linear-gradient(to top, #000066 0%, #0033cc 25%, #ff3300 50%, #ff9900 75%, #ffcc00 100%);
        }

        #poc-scale .color-scale-gradient {
            background: linear-gradient(to top, #2c2c54 0%, #40407a 25%, #706fd3 50%, #f7b731 75%, #ff5252 100%);
        }

        /* Adjust scale position when multiple scales are visible */
        #sst-scale.with-chl-scale {
            left: 140px;
        }

        #poc-scale.with-chl-scale {
            left: 140px;
        }

        #poc-scale.with-sst-scale {
            left: 140px;
        }

        #poc-scale.with-chl-sst-scale {
            left: 250px;
        }

        /* Custom home button control */
        .leaflet-control-home {
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            cursor: pointer;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            margin-top: 10px;
        }

        .leaflet-control-home:hover {
            background: #f4f4f4;
        }

        .leaflet-control-home svg {
            width: 30px;
            height: 30px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <h1>Blue Shark Tracking Project</h1>
                <p>Interactive map showing predictions of blue sharks' (Prionace glauca) foraging hotspots</p>
            </div>
            <nav class="nav-tabs">
                <a href="mission.html" class="nav-tab">Our Mission</a>
                <a href="index.html" class="nav-tab">Explore</a>
                <a href="predict.html" class="nav-tab active">Prediction</a>
                <a href="model.html" class="nav-tab">Bio-tag</a>
				<a href="globe.html" class="nav-tab">3D Tracking</a>
            </nav>
        </div>
    </div>

    <div class="container">
        <!-- Menu toggle button -->
        <button class="menu-toggle" id="menu-toggle" title="Toggle Sidebar">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#5f6368">
                <path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/>
            </svg>
        </button>
        
        <div class="sidebar" id="sidebar">
            <!-- <div class="stats">
                <h4>Dataset Summary</h4>
                <div class="stats-grid">
                    <div class="stats-item">
                        <span class="stats-label">Total Sharks:</span>
                        <span class="stats-value" id="total-sharks">-</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Total Points:</span>
                        <span class="stats-value" id="total-points">-</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Date Range:</span>
                        <span class="stats-value" id="date-range">-</span>
                    </div>
                    <div class="stats-item">
                        <span class="stats-label">Species:</span>
                        <span class="stats-value">Blue Shark</span>
                    </div>
                </div>
            </div> -->
            <div class="controls">
                <h3>Map Controls</h3>
                <div class="control-group">
                    <label>Marine Protected Areas<br>(Might Take a while to load)</label>
                    <button id="toggle-mpa">Load MPAs</button>
                </div>
            </div>
        </div>

        <div id="map">
            <!-- Legend overlay -->
            <!-- <div class="legend" id="legend">
                <div class="legend-header">
                    <span class="legend-title">Legend</span>
                    <span class="legend-toggle">â–¼</span>
                </div>
                <div class="legend-content" id="legend-content">
                    Dynamic content will be populated by JavaScript
                </div>
            </div> -->

            <!-- Map Legend -->
            <div class="map-legend">
                <div class="legend-item">
                    <span class="emoji">ðŸ¦ˆ</span>
                    <span>Recorded occurrences within a month</span>
                </div>
            </div>

            <!-- Prediction Probability Scale -->
            <div class="prediction-scale">
                <div class="prediction-scale-gradient"></div>
                <div class="prediction-scale-labels">
                    <span>High</span>
                    <span>Medium</span>
                    <span>Low</span>
                </div>
                <div class="prediction-scale-title">Foraging Habitat Probability</div>
            </div>

            
            <!-- Bottom time controls overlay -->
            <div class="bottom-time-controls" id="bottom-time-controls">
                <!-- <div class="time-control-header">
                    <div class="time-control-title" id="bottom-control-title">Time Control</div>
                    <div class="time-control-info" id="bottom-control-info">Select a shark in "Show One" mode</div>
                </div> -->
                <div class="time-control-main">
                    <button class="play-button" id="play-button" title="Play/Pause">
                        â–¶
                    </button>
                    <div class="bottom-time-slider-container">
                        <input type="range" class="bottom-time-slider" id="bottom-time-slider" min="0" max="42" value="0">
                        <div class="time-labels">
                            <span id="bottom-start-time">2013-07</span>
                            <span class="current-time-label" id="bottom-current-time">2013-07</span>
                            <span id="bottom-end-time">2017-01</span>
                        </div>
                    </div>
                    <div class="speed-control">
                        <span>Speed:</span>
                        <button class="speed-button" data-speed="0.25">0.25x</button>
                        <button class="speed-button" data-speed="0.5">0.5x</button>
                        <button class="speed-button active" data-speed="1">1x</button>
                        <button class="speed-button" data-speed="2">2x</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Papa Parse for CSV reading -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- Shapefile library for handling shapefiles -->
    <script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script>

    <script>
        // Global variables
        let map;
        let sharkData = {};
        let sharkMetadata = {};
        let sharkLayers = {};
        let allBounds = [];
        let showPoints = true;
        
        // MPA variables
        let mpaLayer = null;
        let showMPA = false;
        
        // Environmental layer variables
        let chlorophyllLayer = null;
        let sstLayer = null;
        let pocLayer = null;
        let showChlorophyll = false;
        let showSST = false;
        let showPOC = false;
        let currentEnvironmentalMonth = null; // Track current month for caching
        
        // Base layer tracking
        let currentBaseLayer = 'Ocean'; // Default base layer
        
        // Show one mode variables
        let showOneMode = false;
        let selectedSharkId = null;
        let currentTimeIndex = 0;
        let timeSliderLayer = null;
        let currentMarker = null; // Reference to the current position marker
        
        // Auto-play variables
        let isPlaying = false;
        let playInterval = null;
        let playSpeed = 1; // 1x speed
        let playStepDelay = 500; // Base delay in ms
        let followMode = false; // Follow mode for map centering during animation (disabled by default)
        
        // Prediction layer variables
        let predictionLayer = null;
        let currentMonthIndex = 0;
        let monthsList = []; // Will be populated with months from 2013-07 to 2017-01
        let sharkMonthMarkers = {}; // Store markers for each shark by month

        // ISO3 to country name mapping
        const iso3ToCountry = {
            'ABNJ': 'Area Beyond National Jurisdiction', 'AFG': 'Afghanistan', 'ALB': 'Albania', 'DZA': 'Algeria', 'ASM': 'American Samoa', 'AND': 'Andorra',
            'AGO': 'Angola', 'AIA': 'Anguilla', 'ATA': 'Antarctica', 'ATG': 'Antigua and Barbuda', 'ARG': 'Argentina',
            'ARM': 'Armenia', 'ABW': 'Aruba', 'AUS': 'Australia', 'AUT': 'Austria', 'AZE': 'Azerbaijan',
            'BHS': 'Bahamas', 'BHR': 'Bahrain', 'BGD': 'Bangladesh', 'BRB': 'Barbados', 'BLR': 'Belarus',
            'BEL': 'Belgium', 'BLZ': 'Belize', 'BEN': 'Benin', 'BMU': 'Bermuda', 'BTN': 'Bhutan',
            'BOL': 'Bolivia', 'BES': 'Bonaire, Sint Eustatius and Saba', 'BIH': 'Bosnia and Herzegovina', 'BWA': 'Botswana', 'BVT': 'Bouvet Island',
            'BRA': 'Brazil', 'IOT': 'British Indian Ocean Territory', 'BRN': 'Brunei', 'BGR': 'Bulgaria', 'BFA': 'Burkina Faso',
            'BDI': 'Burundi', 'CPV': 'Cabo Verde', 'KHM': 'Cambodia', 'CMR': 'Cameroon', 'CAN': 'Canada',
            'CYM': 'Cayman Islands', 'CAF': 'Central African Republic', 'TCD': 'Chad', 'CHL': 'Chile', 'CHN': 'China',
            'CXR': 'Christmas Island', 'CCK': 'Cocos (Keeling) Islands', 'COL': 'Colombia', 'COM': 'Comoros', 'COG': 'Congo',
            'COD': 'Congo (Democratic Republic)', 'COK': 'Cook Islands', 'CRI': 'Costa Rica', 'CIV': 'CÃ´te d\'Ivoire', 'HRV': 'Croatia',
            'CUB': 'Cuba', 'CUW': 'CuraÃ§ao', 'CYP': 'Cyprus', 'CZE': 'Czech Republic', 'DNK': 'Denmark',
            'DJI': 'Djibouti', 'DMA': 'Dominica', 'DOM': 'Dominican Republic', 'ECU': 'Ecuador', 'EGY': 'Egypt',
            'SLV': 'El Salvador', 'GNQ': 'Equatorial Guinea', 'ERI': 'Eritrea', 'EST': 'Estonia', 'SWZ': 'Eswatini',
            'ETH': 'Ethiopia', 'FLK': 'Falkland Islands', 'FRO': 'Faroe Islands', 'FJI': 'Fiji', 'FIN': 'Finland',
            'FRA': 'France', 'GUF': 'French Guiana', 'PYF': 'French Polynesia', 'ATF': 'French Southern Territories', 'GAB': 'Gabon',
            'GMB': 'Gambia', 'GEO': 'Georgia', 'DEU': 'Germany', 'GHA': 'Ghana', 'GIB': 'Gibraltar',
            'GRC': 'Greece', 'GRL': 'Greenland', 'GRD': 'Grenada', 'GLP': 'Guadeloupe', 'GUM': 'Guam',
            'GTM': 'Guatemala', 'GGY': 'Guernsey', 'GIN': 'Guinea', 'GNB': 'Guinea-Bissau', 'GUY': 'Guyana',
            'HTI': 'Haiti', 'HMD': 'Heard Island and McDonald Islands', 'VAT': 'Holy See', 'HND': 'Honduras', 'HKG': 'Hong Kong',
            'HUN': 'Hungary', 'ISL': 'Iceland', 'IND': 'India', 'IDN': 'Indonesia', 'IRN': 'Iran',
            'IRQ': 'Iraq', 'IRL': 'Ireland', 'IMN': 'Isle of Man', 'ISR': 'Israel', 'ITA': 'Italy',
            'JAM': 'Jamaica', 'JPN': 'Japan', 'JEY': 'Jersey', 'JOR': 'Jordan', 'KAZ': 'Kazakhstan',
            'KEN': 'Kenya', 'KIR': 'Kiribati', 'PRK': 'North Korea', 'KOR': 'South Korea', 'KWT': 'Kuwait',
            'KGZ': 'Kyrgyzstan', 'LAO': 'Laos', 'LVA': 'Latvia', 'LBN': 'Lebanon', 'LSO': 'Lesotho',
            'LBR': 'Liberia', 'LBY': 'Libya', 'LIE': 'Liechtenstein', 'LTU': 'Lithuania', 'LUX': 'Luxembourg',
            'MAC': 'Macao', 'MDG': 'Madagascar', 'MWI': 'Malawi', 'MYS': 'Malaysia', 'MDV': 'Maldives',
            'MLI': 'Mali', 'MLT': 'Malta', 'MHL': 'Marshall Islands', 'MTQ': 'Martinique', 'MRT': 'Mauritania',
            'MUS': 'Mauritius', 'MYT': 'Mayotte', 'MEX': 'Mexico', 'FSM': 'Micronesia', 'MDA': 'Moldova',
            'MCO': 'Monaco', 'MNG': 'Mongolia', 'MNE': 'Montenegro', 'MSR': 'Montserrat', 'MAR': 'Morocco',
            'MOZ': 'Mozambique', 'MMR': 'Myanmar', 'NAM': 'Namibia', 'NRU': 'Nauru', 'NPL': 'Nepal',
            'NLD': 'Netherlands', 'NCL': 'New Caledonia', 'NZL': 'New Zealand', 'NIC': 'Nicaragua', 'NER': 'Niger',
            'NGA': 'Nigeria', 'NIU': 'Niue', 'NFK': 'Norfolk Island', 'MKD': 'North Macedonia', 'MNP': 'Northern Mariana Islands',
            'NOR': 'Norway', 'OMN': 'Oman', 'PAK': 'Pakistan', 'PLW': 'Palau', 'PSE': 'Palestine',
            'PAN': 'Panama', 'PNG': 'Papua New Guinea', 'PRY': 'Paraguay', 'PER': 'Peru', 'PHL': 'Philippines',
            'PCN': 'Pitcairn', 'POL': 'Poland', 'PRT': 'Portugal', 'PRI': 'Puerto Rico', 'QAT': 'Qatar',
            'REU': 'RÃ©union', 'ROU': 'Romania', 'RUS': 'Russia', 'RWA': 'Rwanda', 'BLM': 'Saint BarthÃ©lemy',
            'SHN': 'Saint Helena', 'KNA': 'Saint Kitts and Nevis', 'LCA': 'Saint Lucia', 'MAF': 'Saint Martin',
            'SPM': 'Saint Pierre and Miquelon', 'VCT': 'Saint Vincent and the Grenadines', 'WSM': 'Samoa', 'SMR': 'San Marino', 'STP': 'Sao Tome and Principe',
            'SAU': 'Saudi Arabia', 'SEN': 'Senegal', 'SRB': 'Serbia', 'SYC': 'Seychelles', 'SLE': 'Sierra Leone',
            'SGP': 'Singapore', 'SXM': 'Sint Maarten', 'SVK': 'Slovakia', 'SVN': 'Slovenia', 'SLB': 'Solomon Islands',
            'SOM': 'Somalia', 'ZAF': 'South Africa', 'SGS': 'South Georgia and the South Sandwich Islands', 'SSD': 'South Sudan', 'ESP': 'Spain',
            'LKA': 'Sri Lanka', 'SDN': 'Sudan', 'SUR': 'Suriname', 'SJM': 'Svalbard and Jan Mayen', 'SWE': 'Sweden',
            'CHE': 'Switzerland', 'SYR': 'Syria', 'TWN': 'Taiwan', 'TJK': 'Tajikistan', 'TZA': 'Tanzania',
            'THA': 'Thailand', 'TLS': 'Timor-Leste', 'TGO': 'Togo', 'TKL': 'Tokelau', 'TON': 'Tonga',
            'TTO': 'Trinidad and Tobago', 'TUN': 'Tunisia', 'TUR': 'Turkey', 'TKM': 'Turkmenistan', 'TCA': 'Turks and Caicos Islands',
            'TUV': 'Tuvalu', 'UGA': 'Uganda', 'UKR': 'Ukraine', 'ARE': 'United Arab Emirates', 'GBR': 'United Kingdom',
            'USA': 'United States', 'UMI': 'United States Minor Outlying Islands', 'URY': 'Uruguay', 'UZB': 'Uzbekistan', 'VUT': 'Vanuatu',
            'VEN': 'Venezuela', 'VNM': 'Vietnam', 'VGB': 'Virgin Islands (British)', 'VIR': 'Virgin Islands (U.S.)', 'WLF': 'Wallis and Futuna',
            'ESH': 'Western Sahara', 'YEM': 'Yemen', 'ZMB': 'Zambia', 'ZWE': 'Zimbabwe'
        };

        // Function to get country name from ISO3 code
        // Handles both single codes and multiple codes separated by semicolons (for transboundary sites)
        function getCountryName(iso3Code) {
            if (!iso3Code) {
                return 'Unknown';
            }
            
            // Check if this is a transboundary site (contains semicolons)
            if (iso3Code.includes(';')) {
                const codes = iso3Code.split(';');
                const countryNames = codes.map(code => {
                    const trimmedCode = code.trim();
                    return iso3ToCountry[trimmedCode] || trimmedCode;
                }).filter(name => name); // Remove any empty names
                
                return countryNames.length > 0 ? countryNames.join(' & ') : 'Unknown';
            } else {
                // Single country code
                return iso3ToCountry[iso3Code] || iso3Code || 'Unknown';
            }
        }

        // SVG icons for visibility toggle buttons
        const EYE_VISIBLE_ICON = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#2c3e50"><path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z"/></svg>';
        const EYE_HIDDEN_ICON = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#95a5a6"><path d="m644-428-58-58q9-47-27-88t-93-32l-58-58q17-8 34.5-12t37.5-4q75 0 127.5 52.5T660-500q0 20-4 37.5T644-428Zm128 126-58-56q38-29 67.5-63.5T832-500q-50-101-143.5-160.5T480-720q-29 0-57 4t-55 12l-62-62q41-17 84-25.5t90-8.5q151 0 269 83.5T920-500q-23 59-60.5 109.5T772-302Zm20 246L624-222q-35 11-70.5 16.5T480-200q-151 0-269-83.5T40-500q21-53 53-98.5t73-81.5L56-792l56-56 736 736-56 56ZM222-624q-29 26-53 57t-41 67q50 101 143.5 160.5T480-280q20 0 39-2.5t39-5.5l-36-38q-11 3-21 4.5t-21 1.5q-75 0-127.5-52.5T300-500q0-11 1.5-21t4.5-21l-84-82Zm319 93Zm-151 75Z"/></svg>';

        // Color palette for different sharks
        const colors = [
            '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
            '#1abc9c', '#34495e', '#e67e22', '#ff6b6b', '#e91e63',
            '#00bcd4', '#ff5722', '#795548', '#607d8b', '#ffc107'
        ];

        // Calculate distance between two lat/lon points using Haversine formula
        function calculateDistance(track) {
            if (track.length < 2) return 0;
            
            let totalDistance = 0;
            for (let i = 1; i < track.length; i++) {
                const R = 6371; // Earth's radius in km
                const dLat = (track[i].lat - track[i-1].lat) * Math.PI / 180;
                const dLon = (track[i].lon - track[i-1].lon) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(track[i-1].lat * Math.PI / 180) * Math.cos(track[i].lat * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                totalDistance += R * c;
            }
            return totalDistance;
        }

        // Show notification function
        function showNotification(message, duration = 5000) {
            // Remove existing notification if any
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            // Add click to dismiss functionality
            notification.addEventListener('click', () => {
                notification.classList.add('fadeOut');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            });

            // Add to document
            document.body.appendChild(notification);

            // Auto-dismiss after duration
            setTimeout(() => {
                if (notification.parentNode && !notification.classList.contains('fadeOut')) {
                    notification.classList.add('fadeOut');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, duration);
        }

        // Load MPA data from shapefiles and create layer
        async function loadMPALayer() {
            console.log('Loading MPA data from shapefiles...');
            
            // Show loading indicator on button
            const mpaButton = document.getElementById('toggle-mpa');
            if (mpaButton) {
                mpaButton.classList.add('button-loading');
                mpaButton.textContent = 'Loading MPAs...';
            }
            
            // Show loading notification
            showNotification('Loading Marine Protected Areas...', 2000);
            
            if (mpaLayer) {
                map.removeLayer(mpaLayer);
            }
            
            mpaLayer = L.layerGroup();
            
            const shapefiles = ['0ps', '1ps', '2ps'];
            let totalFeatures = 0;
            
            try {
                for (let i = 0; i < shapefiles.length; i++) {
                    const filename = shapefiles[i];
                    console.log(`Loading ${filename}.shp... (${i + 1}/${shapefiles.length})`);
                    
                    // Update button text with progress
                    if (mpaButton) {
                        mpaButton.textContent = `Loading MPAs... (${i + 1}/${shapefiles.length})`;
                    }
                    
                    // Load the shapefile
                    const collection = await shapefile.read(`data/mpa/${filename}.shp`);
                    
                    if (collection && collection.features) {
                        console.log(`Loaded ${collection.features.length} features from ${filename}.shp`);
                        
                        collection.features.forEach(feature => {
                            if (feature.geometry && (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon')) {
                                // Convert GeoJSON to Leaflet layer
                                const leafletLayer = L.geoJSON(feature, {
                                    style: {
                                        color: '#1e88e5',
                                        weight: 1,
                                        opacity: 0.7,
                                        fillColor: '#42a5f5',
                                        fillOpacity: 0.15
                                    },
                                    onEachFeature: (feature, layer) => {
                                        // Create popup with MPA information
                                        const props = feature.properties || {};
                                        const popupContent = `
                                            <div style="font-family: Arial, sans-serif; max-width: 250px;">
                                                <h4 style="margin: 0 0 10px 0; color: #1565c0;">${props.NAME || 'Marine Protected Area'}</h4>
                                                <p><strong>ID:</strong> ${props.WDPAID || 'N/A'}</p>
                                                <p><strong>Designation:</strong> ${props.DESIG_ENG || props.DESIG || 'Protected Area'}</p>
                                                <p><strong>Country:</strong> ${getCountryName(props.ISO3)}</p>
                                                <p><strong>Status:</strong> ${props.STATUS || 'Unknown'}</p>
                                                <p><strong>Marine Area:</strong> ${props.REP_M_AREA ? parseFloat(props.REP_M_AREA).toFixed(2) + ' kmÂ²' : 'Unknown'}</p>
                                                </div>
                                                `;
                                                // <p><strong>IUCN Category:</strong> ${props.IUCN_CAT || 'Not specified'}</p>
                                        layer.bindPopup(popupContent);
                                    }
                                });
                                
                                mpaLayer.addLayer(leafletLayer);
                                totalFeatures++;
                            }
                        });
                    }
                }
                
                console.log(`Total MPA features loaded: ${totalFeatures}`);
                
                // Remove loading indicator and update button
                if (mpaButton) {
                    mpaButton.classList.remove('button-loading');
                    mpaButton.textContent = `Show MPAs (${totalFeatures} zones)`;
                }
                
                // Show success notification
                showNotification(`Successfully loaded ${totalFeatures} Marine Protected Areas`, 3000);
                
            } catch (error) {
                console.error('Error loading MPA shapefiles:', error);
                
                // Remove loading indicator on error
                if (mpaButton) {
                    mpaButton.classList.remove('button-loading');
                    mpaButton.textContent = 'Show MPAs (Error)';
                }
                
                showNotification('Error loading MPA data. Please check that shapefile files are available.', 5000);
            }
        }

        // Toggle MPA layer visibility
        async function toggleMPALayer() {
            const toggleButton = document.getElementById('toggle-mpa');
            
            // Prevent clicking while loading
            if (toggleButton && toggleButton.classList.contains('button-loading')) {
                return;
            }
            
            if (!mpaLayer) {
                await loadMPALayer();
                return;
            }
            
            if (showMPA) {
                // Hide MPA layer
                if (mpaLayer && map.hasLayer(mpaLayer)) {
                    map.removeLayer(mpaLayer);
                }
                showMPA = false;
                toggleButton.classList.remove('active');
                const count = toggleButton.textContent.match(/\((\d+)\)/);
                if (count) {
                    toggleButton.textContent = `Show MPAs (${count[1]} zones)`;
                } else {
                    toggleButton.textContent = 'Show MPAs';
                }
            } else {
                // Show MPA layer
                if (mpaLayer) {
                    map.addLayer(mpaLayer);
                }
                showMPA = true;
                toggleButton.classList.add('active');
                const count = toggleButton.textContent.match(/\((\d+)\)/);
                if (count) {
                    toggleButton.textContent = `Hide MPAs (${count[1]} zones)`;
                } else {
                    toggleButton.textContent = 'Hide MPAs';
                }
            }
            
            // Update legend to show/hide MPA item
            // updateLegendContent();
        }



        // Function to update time slider text color based on active layers
        function updateTimeSliderTextColor() {
            const timeLabels = document.querySelector('.time-labels');
            if (!timeLabels) return;

            // Check if we should use white text
            const useWhiteText = showChlorophyll || showSST || showPOC || currentBaseLayer === 'Satellite';
            
            if (useWhiteText) {
                timeLabels.classList.add('white-text');
            } else {
                timeLabels.classList.remove('white-text');
            }
        }

        // Function to update max zoom based on environmental layer visibility
        function updateMaxZoom() {
            // If any environmental layer is visible, limit zoom to 5
            if (showChlorophyll || showSST || showPOC) {
                map.setMaxZoom(5);
                // If current zoom is greater than 5, zoom out to 5 and show notification
                if (map.getZoom() > 5) {
                    map.setZoom(5);
                }
            } else {
                // No environmental layers, allow full zoom (20)
                map.setMaxZoom(20);
            }
        }

        // Initialize the map
        function initMap() {
            map = L.map('map', {
                renderer: L.canvas(), // Use canvas renderer for better performance with many points
                zoomControl: false, // Disable default zoom control
                scrollWheelZoom: true, // Enable scroll wheel zoom by default
                maxZoom: 5 // Limit max zoom to match prediction tiles
            }).setView([40.0, -60.0], 4);

            // Add base layers
            const oceanBase = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            //     attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            // });

            // Layer control - add first so it appears on top
            const baseMaps = {
                "Ocean": oceanBase,
                // "Satellite": satellite
            };

            // const layerControl = L.control.layers(baseMaps, null, {
            //     position: 'topright'
            // }).addTo(map);

            // Listen for base layer changes
            // map.on('baselayerchange', function(e) {
            //     currentBaseLayer = e.name;
            //     updateTimeSliderTextColor();
            // });

            // Add zoom control on the right side - add after layer control so it appears below
            L.control.zoom({
                position: 'topright'
            }).addTo(map);
            
            // Add horizontal scale control at bottom right (positioned to avoid time slider)
            const scaleControl = L.control.scale({
                position: 'bottomright',
                maxWidth: 200,
                metric: true,
                imperial: true,
                updateWhenIdle: false
            }).addTo(map);
            
            // Move scale control up to avoid collision with time slider
            setTimeout(() => {
                const scaleElement = document.querySelector('.leaflet-control-scale');
                if (scaleElement) {
                    scaleElement.style.bottom = '90px';
                }
            }, 100);
            
            // Set up map interaction listeners for follow mode
            setupMapInteractionListeners();
            
            // Initialize months list and prediction layer
            initializeMonthsAndPrediction();
        }
        
        // Initialize months list from 2013-07 to 2017-01
        function initializeMonthsAndPrediction() {
            // Generate months from July 2013 to January 2017
            const startYear = 2013;
            const startMonth = 7; // July
            const endYear = 2017;
            const endMonth = 1; // January
            
            for (let year = startYear; year <= endYear; year++) {
                const firstMonth = (year === startYear) ? startMonth : 1;
                const lastMonth = (year === endYear) ? endMonth : 12;
                
                for (let month = firstMonth; month <= lastMonth; month++) {
                    monthsList.push({
                        year: year,
                        month: month,
                        dateStr: `${year}-${String(month).padStart(2, '0')}-01`,
                        label: `${year}-${String(month).padStart(2, '0')}`
                    });
                }
            }
            
            // console.log(`Initialized ${monthsList.length} months from ${monthsList[0].label} to ${monthsList[monthsList.length-1].label}`);
            
            // Initialize prediction layer
            updatePredictionLayer(0);
            
            // Update time slider
            updateTimeSliderForMonths();
        }
        
        // Update prediction tile layer for current month
        function updatePredictionLayer(monthIndex) {
            // Remove existing prediction layer
            if (predictionLayer) {
                map.removeLayer(predictionLayer);
            }
            
            // Get current month info
            const monthInfo = monthsList[monthIndex];
            if (!monthInfo) return;
            
            // Create tile layer for this month
            predictionLayer = L.tileLayer(`tiles/predict/${monthInfo.dateStr}/{z}/{x}/{y}.png`, {
                opacity: 0.7,
                attribution: 'Foraging habitat predictions',
                minZoom: 0,
                maxZoom: 5
            });
            
            predictionLayer.addTo(map);
            // console.log(`Loaded prediction tiles for ${monthInfo.label}`);
        }
        
        // Update the time slider for months
        function updateTimeSliderForMonths() {
            const slider = document.getElementById('bottom-time-slider');
            slider.min = 0;
            slider.max = monthsList.length - 1;
            slider.value = currentMonthIndex;
            
            // Update labels
            document.getElementById('bottom-start-time').textContent = monthsList[0].label;
            document.getElementById('bottom-end-time').textContent = monthsList[monthsList.length - 1].label;
            document.getElementById('bottom-current-time').textContent = monthsList[currentMonthIndex].label;
        }
        
        // Update month display (both prediction layer and shark markers)
        function updateMonthDisplay() {
            if (monthsList.length === 0) return;
            
            // Update prediction layer
            updatePredictionLayer(currentMonthIndex);
            
            // Update shark markers
            updateSharkMarkersForMonth(currentMonthIndex);
            
            // Update time display
            const monthInfo = monthsList[currentMonthIndex];
            document.getElementById('bottom-current-time').textContent = monthInfo.label;
        }

        // Load and parse CSV data
        async function loadData() {
            try {
                // First, load metadata
                const metadataResponse = await fetch('data/blue-shark-gps/Braun_atn_tag_deployment_metadata.csv');
                const metadataCsv = await metadataResponse.text();
                const metadataData = Papa.parse(metadataCsv, { header: true, skipEmptyLines: true });

                // Process metadata
                metadataData.data.forEach(row => {
                    sharkMetadata[row['Deployment ID']] = {
                        species: row['Species'],
                        length: row['Animal Length_cm'],
                        sex: row['Animal Sex'],
                        deploymentStart: row['Deployment Start Datetime'],
                        deploymentStop: row['Deployment Stop Datetime'],
                        startLat: parseFloat(row['geospatial_lat_start']),
                        startLon: parseFloat(row['geospatial_lon_start']),
                        endLat: parseFloat(row['geospatial_lat_end']),
                        endLon: parseFloat(row['geospatial_lon_end']),
                        endType: row['end_type']
                    };
                });

                // Define all shark files to load
                const sharkFiles = [
                    'filtered_160424_2013_132346pnas_atn.csv',
                    'filtered_160424_2014_141195pnas_atn.csv',
                    'filtered_160424_2015_141261pnas_atn_filtered.csv',
                    'filtered_160424_2015_141264pnas_atn.csv',
                    'filtered_160424_2015_141268pnas_atn.csv',
                    'filtered_160424_2015_141270pnas_atn.csv',
                    'filtered_160424_2016_106744pnas_atn_filtered.csv',
                    'filtered_160424_2016_106745pnas_atn_filtered.csv',
                    'filtered_160424_2016_106746pnas_atn_filtered.csv',
                    'filtered_160424_2016_106747pnas_atn_filtered.csv',
                    'filtered_160424_2016_106748pnas_atn.csv',
                    'filtered_160424_2016_141262pnas_atn_filtered.csv',
                    'filtered_160424_2016_141263pnas_atn.csv',
                    'filtered_160424_2016_141265pnas_atn.csv',
                    'filtered_160424_2016_141266pnas_atn.csv',
                    'filtered_160424_2016_165927pnas_atn.csv',
                    'filtered_160424_2016_165928pnas_atn.csv'
                ];

                // Load all shark tracking files
                const sharkPromises = sharkFiles.map(async (filename, index) => {
                    try {
                        // Update loading progress
                        const progressEl = document.getElementById('loading-progress');
                        if (progressEl) {
                            progressEl.textContent = `Loading ${filename}... (${index + 1}/${sharkFiles.length})`;
                        }
                        
                        const response = await fetch(`data/blue-shark-gps/${filename}`);
                        const csvText = await response.text();
                        const parsedData = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                        
                        parsedData.data.forEach(row => {
                            const id = row.id;
                            const lat = parseFloat(row.lat);
                            const lon = parseFloat(row.lon);
                            const date = new Date(row.date);
                            
                            if (!isNaN(lat) && !isNaN(lon) && !isNaN(date.getTime())) {
                                if (!sharkData[id]) {
                                    sharkData[id] = [];
                                }
                                sharkData[id].push({
                                    lat: lat,
                                    lon: lon,
                                    date: date,
                                    lc: row.lc
                                });
                                
                                allBounds.push([lat, lon]);
                            }
                        });
                        
                        return filename;
                    } catch (error) {
                        console.warn(`Failed to load ${filename}:`, error);
                        return null;
                    }
                });

                // Wait for all shark files to load
                const results = await Promise.all(sharkPromises);
                const successfulLoads = results.filter(r => r !== null);
                
                console.log(`Successfully loaded ${successfulLoads.length} out of ${sharkFiles.length} shark files`);

                // Sort tracking data by date for each shark
                Object.keys(sharkData).forEach(id => {
                    sharkData[id].sort((a, b) => a.date - b.date);
                });

                console.log('Loaded data:', Object.keys(sharkData).length, 'sharks');
                console.log('Metadata:', Object.keys(sharkMetadata).length, 'entries');
                
                // updateStats();
                createSharkLayers();
                
                // Initialize legend content
                // updateLegendContent();
                
                // Fit map to show all visible sharks on initial load
                fitMapToVisibleSharks();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('shark-list').innerHTML = '<div style="color: red; padding: 1rem;">Error loading data. Please check that CSV files are in the data directory.</div>';
            }
        }

        // Update statistics
        // function updateStats() {
        //     const totalSharks = Object.keys(sharkData).length;
        //     const totalPoints = Object.values(sharkData).reduce((sum, track) => sum + track.length, 0);
            
        //     let minDate = new Date();
        //     let maxDate = new Date(0);
            
        //     Object.values(sharkData).forEach(track => {
        //         track.forEach(point => {
        //             if (point.date < minDate) minDate = point.date;
        //             if (point.date > maxDate) maxDate = point.date;
        //         });
        //     });

        //     document.getElementById('total-sharks').textContent = totalSharks;
        //     document.getElementById('total-points').textContent = totalPoints.toLocaleString();
            
        //     const dateOptions = { year: 'numeric', month: 'short' };
        //     document.getElementById('date-range').textContent = 
        //         `${minDate.toLocaleDateString('en-US', dateOptions)} - ${maxDate.toLocaleDateString('en-US', dateOptions)}`;
        // }

        // Create map layers for each shark - organize by month
        function createSharkLayers() {
            // Group shark data points by month for each shark
            Object.keys(sharkData).forEach(sharkId => {
                const track = sharkData[sharkId];
                sharkMonthMarkers[sharkId] = {};
                
                // Group points by year-month
                track.forEach(point => {
                    const year = point.date.getFullYear();
                    const month = point.date.getMonth() + 1; // 1-based month
                    const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                    
                    if (!sharkMonthMarkers[sharkId][monthKey]) {
                        sharkMonthMarkers[sharkId][monthKey] = [];
                    }
                    sharkMonthMarkers[sharkId][monthKey].push(point);
                });
            });
            
            // console.log(`Organized shark data by month for ${Object.keys(sharkData).length} sharks`);
            
            // Initialize the display for the first month
            updateSharkMarkersForMonth(currentMonthIndex);
        }
        
        // Update shark markers for specific month
        function updateSharkMarkersForMonth(monthIndex) {
            // Remove existing shark layers
            Object.values(sharkLayers).forEach(sharkLayer => {
                if (sharkLayer.layer) {
                    map.removeLayer(sharkLayer.layer);
                }
            });
            sharkLayers = {};
            
            // Get current month
            const monthInfo = monthsList[monthIndex];
            if (!monthInfo) return;
            
            const monthKey = monthInfo.label; // Format: YYYY-MM
            // console.log(`Updating shark markers for ${monthKey}`);
            
            // For each shark, show ALL points if they have data in this month
            Object.keys(sharkMonthMarkers).forEach((sharkId, index) => {
                const monthData = sharkMonthMarkers[sharkId][monthKey];
                
                if (monthData && monthData.length > 0) {
                    // Get metadata
                    const metadata = sharkMetadata[sharkId] || {};
                    const yearMatch = sharkId.match(/160424_(\d{4})/);
                    const year = yearMatch ? yearMatch[1] : sharkId.match(/(\d{4})/)?.[1] || 'Unknown';
                    const shortId = sharkId.replace('160424_', '').replace(`${year}_`, '').replace('pnas_atn', '').replace('_filtered', '');
                    
                    // Create layer group for this shark
                    const layerGroup = L.layerGroup();
                    
                    // Show ALL points for this month with shark emoji
                    monthData.forEach(point => {
                        // Create shark emoji marker
                        const sharkIcon = L.divIcon({
                            html: 'ðŸ¦ˆ',
                            className: 'shark-emoji-marker',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12],
                            popupAnchor: [0, -12]
                        });
                        
                        const marker = L.marker([point.lat, point.lon], {
                            icon: sharkIcon
                        });
                        
                        // Create popup
                        const popupContent = `
                            <div style="font-family: Arial, sans-serif;">
                                <h4 style="margin: 0 0 10px 0; color: #2c3e50;">Shark ${shortId} (${year})</h4>
                                <p><strong>Date:</strong> ${point.date.toLocaleDateString()}</p>
                                <p><strong>Location:</strong> ${point.lat.toFixed(4)}Â°, ${point.lon.toFixed(4)}Â°</p>
                                <p><strong>Species:</strong> ${metadata.species || 'Blue Shark (Prionace glauca)'}</p>
                                <p><strong>Points this month:</strong> ${monthData.length}</p>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        layerGroup.addLayer(marker);
                    });
                    
                    sharkLayers[sharkId] = {
                        layer: layerGroup,
                        visible: true
                    };
                    
                    layerGroup.addTo(map);
                }
            });
            
            const visibleSharks = Object.keys(sharkLayers).length;
            // console.log(`Displaying ${visibleSharks} sharks with data in ${monthKey}`);
        }

        // Fit map to all currently visible sharks
        function fitMapToVisibleSharks() {
            // Fit to all currently visible shark layers
            const visibleSharkLayers = Object.values(sharkLayers).filter(s => s.visible);
            if (visibleSharkLayers.length > 0) {
                // Collect all lat/lng bounds from visible sharks
                let allVisibleBounds = [];
                Object.keys(sharkData).forEach(sharkId => {
                    if (sharkLayers[sharkId] && sharkLayers[sharkId].visible) {
                        const track = sharkData[sharkId];
                        const trackLatLngs = track.map(point => [point.lat, point.lon]);
                        allVisibleBounds = allVisibleBounds.concat(trackLatLngs);
                    }
                });
                
                if (allVisibleBounds.length > 0) {
                    const bounds = L.latLngBounds(allVisibleBounds);
                    map.fitBounds(bounds.pad(0.1));
                }
            }
        }

        // Event listeners for controls
        function setupEventListeners() {
            
            // Menu toggle button
            document.getElementById('menu-toggle').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                const container = document.querySelector('.container');
                
                sidebar.classList.toggle('hidden');
                container.classList.toggle('sidebar-hidden');
                
                // Trigger map resize after animation completes
                setTimeout(() => {
                    map.invalidateSize();
                }, 300);
            });
            
            // Bottom time slider event listener - now controls months
            document.getElementById('bottom-time-slider').addEventListener('input', (e) => {
                currentMonthIndex = parseInt(e.target.value);
                updateMonthDisplay();
                
                // Pause animation when user manually changes slider
                if (isPlaying) {
                    pauseAnimation();
                }
            });
            
            // Play/Pause button
            document.getElementById('play-button').addEventListener('click', () => {
                if (isPlaying) {
                    pauseAnimation();
                } else {
                    startAnimation();
                }
            });
            
            // Speed control buttons
            document.querySelectorAll('.speed-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    // Update active speed button
                    document.querySelectorAll('.speed-button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Update play speed
                    playSpeed = parseFloat(e.target.dataset.speed);
                    
                    // Restart animation if playing
                    if (isPlaying) {
                        pauseAnimation();
                        startAnimation();
                    }
                });
            });
            
            // Follow button
            // document.getElementById('follow-button').addEventListener('click', (e) => {
            //     followMode = !followMode;
            //     const button = e.target;
            //     if (followMode) {
            //         button.classList.add('active');
            //         button.textContent = 'ðŸ¦ˆ Following';
            //     } else {
            //         button.classList.remove('active');
            //         button.textContent = 'ðŸ¦ˆ Follow';
            //     }
            // });
            
            // Map dragging control for bottom time controls
            const bottomControls = document.getElementById('bottom-time-controls');
            bottomControls.addEventListener('mouseenter', () => {
                map.dragging.disable();
                map.doubleClickZoom.disable();
                map.scrollWheelZoom.disable();
            });
            
            bottomControls.addEventListener('mouseleave', () => {
                map.dragging.enable();
                map.doubleClickZoom.enable();
                map.scrollWheelZoom.enable();
            });

            // MPA toggle event listener
            document.getElementById('toggle-mpa').addEventListener('click', toggleMPALayer);
            
            // Initialize time slider text color
            updateTimeSliderTextColor();
        }
        
        // Helper function to disable follow mode
        function disableFollowMode() {
            if (followMode) {
                followMode = false;
                const followButton = document.getElementById('follow-button');
                followButton.classList.remove('active');
                followButton.textContent = 'ðŸ¦ˆ Follow';
            }
        }
        
        // Set up map interaction listeners (called after map initialization)
        function setupMapInteractionListeners() {
            map.on('dragstart', disableFollowMode);
        }
        

        
        // Start animation - now animates through months
        function startAnimation() {
            if (isPlaying || monthsList.length === 0) return;
            
            // If we're at the end, reset to the beginning
            if (currentMonthIndex >= monthsList.length - 1) {
                currentMonthIndex = 0;
                document.getElementById('bottom-time-slider').value = 0;
                updateMonthDisplay();
            }
            
            isPlaying = true;
            document.getElementById('play-button').textContent = 'â¸';
            document.getElementById('play-button').classList.add('playing');
            
            const delay = playStepDelay / playSpeed;
            
            playInterval = setInterval(() => {
                if (currentMonthIndex >= monthsList.length - 1) {
                    // Reached the end, stop animation
                    pauseAnimation();
                    return;
                }
                
                currentMonthIndex++;
                
                // Update slider position
                document.getElementById('bottom-time-slider').value = currentMonthIndex;
                
                // Update display
                updateMonthDisplay();
                
            }, delay);
        }
        
        // Pause animation
        function pauseAnimation() {
            if (!isPlaying) return;
            
            isPlaying = false;
            document.getElementById('play-button').textContent = 'â–¶';
            document.getElementById('play-button').classList.remove('playing');
            
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }


        // Filter sharks by year
        // function filterSharksByYear(year) {
        //     Object.keys(sharkLayers).forEach(sharkId => {
        //         const sharkYear = sharkId.match(/(\d{4})/)[1];
		// 		console.log(sharkId, sharkYear, year);
        //         const shouldShow = year === 'all' || sharkYear === year;
                
        //         if (shouldShow && !sharkLayers[sharkId].visible) {
        //             map.addLayer(sharkLayers[sharkId].layer);
        //             sharkLayers[sharkId].visible = true;
        //         } else if (!shouldShow && sharkLayers[sharkId].visible) {
        //             map.removeLayer(sharkLayers[sharkId].layer);
        //             sharkLayers[sharkId].visible = false;
        //         }
        //     });
            
        //     // Update shark list visibility
        //     document.querySelectorAll('.shark-item').forEach(item => {
        //         const sharkId = item.dataset.sharkId;
        //         const sharkYear = sharkId.match(/(\d{4})/)[1];
        //         const shouldShow = year === 'all' || sharkYear === year;
        //         item.style.display = shouldShow ? 'block' : 'none';
        //     });
        // }

        // Legend management functions
        // function updateLegendContent() {
        //     const legendContent = document.getElementById('legend-content');
            
        //     if (showOneMode && selectedSharkId) {
        //         // Show One mode - display current position and static markers
        //         legendContent.innerHTML = `
        //             <div class="legend-item">
        //                 <div class="legend-color" style="background-color: #e74c3c;"></div>
        //                 <span class="legend-text">Deployment Location</span>
        //             </div>
        //             <div class="legend-item">
        //                 <div class="legend-color" style="background-color: #27ae60;"></div>
        //                 <span class="legend-text">Final Location</span>
        //             </div>
        //             <div class="legend-item">
        //                 <div class="legend-emoji">ðŸ¦ˆ</div>
        //                 <span class="legend-text">Current Position</span>
        //             </div>
        //             ${showMPA && mpaLayer ? `
        //             <div class="legend-item">
        //                 <div class="legend-color" style="background-color: #42a5f5; border: 1px solid #1e88e5;"></div>
        //                 <span class="legend-text">Marine Protected Areas</span>
        //             </div>
        //             ` : ''}
        //             ${showChlorophyll && chlorophyllLayer ? `
        //             <div class="legend-item">
        //                 <div class="legend-color" style="background: linear-gradient(90deg, #000080 0%, #0066cc 25%, #00ccff 50%, #66ff66 75%, #ffff00 100%); opacity: 0.6;"></div>
        //                 <span class="legend-text">Chlorophyll Concentration</span>
        //             </div>
        //             ` : ''}
        //             ${showSST && sstLayer ? `
        //             <div class="legend-item">
        //                 <div class="legend-color" style="background: linear-gradient(90deg, #000066 0%, #0033cc 25%, #ff3300 50%, #ff9900 75%, #ffcc00 100%); opacity: 0.6;"></div>
        //                 <span class="legend-text">Sea Surface Temperature</span>
        //             </div>
        //             ` : ''}
        //             ${showPOC && pocLayer ? `
        //             <div class="legend-item">
        //                 <div class="legend-color" style="background: linear-gradient(90deg, #800080 0%, #9932cc 25%, #ba55d3 50%, #daa520 75%, #ffff00 100%); opacity: 0.6;"></div>
        //                 <span class="legend-text">Particulate Organic Carbon</span>
        //             </div>
        //             ` : ''}
        //         `;
        //     } else {
        //         // Show All/Hide All mode - display visible sharks
        //         // Use same sorting order as shark list
        //         const sortedSharkIds = Object.keys(sharkData).sort();
        //         const visibleSharks = sortedSharkIds.filter(sharkId => 
        //             sharkLayers[sharkId] && sharkLayers[sharkId].visible
        //         );
                
        //         if (visibleSharks.length === 0) {
        //             legendContent.innerHTML = `
        //                 <div class="legend-item">
        //                     <span class="legend-text" style="color: #7f8c8d; font-style: italic;">No sharks visible</span>
        //                 </div>
        //             `;
        //         } else {
        //             let content = `
        //                 <div class="legend-item">
        //                     <div class="legend-color" style="background-color: #e74c3c;"></div>
        //                     <span class="legend-text">Deployment Location</span>
        //                 </div>
        //                 <div class="legend-item">
        //                     <div class="legend-color" style="background-color: #27ae60;"></div>
        //                     <span class="legend-text">Last Known Position</span>
        //                 </div>
        //                 ${showMPA && mpaLayer ? `
        //                 <div class="legend-item">
        //                     <div class="legend-color" style="background-color: #42a5f5; border: 1px solid #1e88e5;"></div>
        //                     <span class="legend-text">Marine Protected Areas</span>
        //                 </div>
        //                 ` : ''}
        //                 ${showChlorophyll && chlorophyllLayer ? `
        //                 <div class="legend-item">
        //                     <div class="legend-color" style="background: linear-gradient(90deg, #000080 0%, #0066cc 25%, #00ccff 50%, #66ff66 75%, #ffff00 100%); opacity: 0.6;"></div>
        //                     <span class="legend-text">Chlorophyll Concentration</span>
        //                 </div>
        //                 ` : ''}
        //                 ${showSST && sstLayer ? `
        //                 <div class="legend-item">
        //                     <div class="legend-color" style="background: linear-gradient(90deg, #000066 0%, #0033cc 25%, #ff3300 50%, #ff9900 75%, #ffcc00 100%); opacity: 0.6;"></div>
        //                     <span class="legend-text">Sea Surface Temperature</span>
        //                 </div>
        //                 ` : ''}
        //                 ${showPOC && pocLayer ? `
        //                 <div class="legend-item">
        //                     <div class="legend-color" style="background: linear-gradient(90deg, #800080 0%, #9932cc 25%, #ba55d3 50%, #daa520 75%, #ffff00 100%); opacity: 0.6;"></div>
        //                     <span class="legend-text">Particulate Organic Carbon</span>
        //                 </div>
        //                 ` : ''}
        //             `;
                    
        //             // Calculate approximate height to determine if legend would overflow
        //             // Base height: ~60px for static items + header
        //             // Each shark item: ~22px (including margins)
        //             // Available space: roughly viewport height - 120px (for header) - 60px (legend position)
        //             const baseHeight = 80; // Static items + padding
        //             const itemHeight = 22; // Approximate height per shark item
        //             const availableHeight = window.innerHeight - 180; // Account for header and positioning
        //             const maxSharkItems = Math.floor((availableHeight - baseHeight) / itemHeight);
        //             // console.log('Available height for legend:', availableHeight, 'Max shark items:', maxSharkItems);
        //             // console.log('Visible sharks:', visibleSharks.length);
                    
        //             if (visibleSharks.length <= maxSharkItems) {
        //                 // Show individual sharks if they fit without overflowing
        //                 content += '<div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #ecf0f1;"><div class="legend-shark-list">';
        //                 visibleSharks.forEach(sharkId => {
        //                     const color = sharkLayers[sharkId].color;
        //                     const yearMatch = sharkId.match(/160424_(\d{4})/);
        //                     const year = yearMatch ? yearMatch[1] : sharkId.match(/(\d{4})/)[1];
        //                     const shortId = sharkId.replace('160424_', '').replace(`${year}_`, '').replace('pnas_atn', '').replace('_filtered', '');
                            
        //                     content += `
        //                         <div class="legend-shark-item">
        //                             <svg width="20" height="12" style="margin-right: 8px; vertical-align: middle;">
        //                                 <line x1="2" y1="6" x2="18" y2="6" stroke="${color}" stroke-width="3" stroke-linecap="round"/>
        //                             </svg>
        //                             <span class="legend-text">Shark ${shortId} (${year})</span>
        //                         </div>
        //                     `;
        //                 });
        //                 content += '</div></div>';
        //             } else {
        //                 // Show count if legend would overflow the map
        //                 content += `
        //                     <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #ecf0f1;">
        //                         <div class="legend-item">
        //                             <span class="legend-text" style="color: #3498db; font-weight: bold;">${visibleSharks.length} sharks visible</span>
        //                         </div>
        //                     </div>
        //                 `;
        //             }
                    
        //             legendContent.innerHTML = content;
        //         }
        //     }
        // }
        
        // function toggleLegend() {
        //     const legend = document.getElementById('legend');
        //     const toggle = legend.querySelector('.legend-toggle');
            
        //     legend.classList.toggle('collapsed');
            
        //     if (legend.classList.contains('collapsed')) {
        //         toggle.textContent = 'â–¶';
        //         legend.querySelector('.legend-title').textContent = 'View Legend';
        //     } else {
        //         toggle.textContent = 'â–¼';
        //         legend.querySelector('.legend-title').textContent = 'Legend';
        //         updateLegendContent(); // Refresh content when expanding
        //     }
        // }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            setupEventListeners();
            loadData();
        });
    </script>
</body>
</html>
